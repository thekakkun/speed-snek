function t(t,e){return Math.sqrt((t.x-e.x)**2+(t.y-e.y)**2)}function e(t,e){if("center"in e){const[{x:s,y:i},{x:n,y:a}]=t,{center:{x:h,y:r},radius:o}=e,c=(s-n)**2+(i-a)**2,d=(s-n)*(n-h)+(i-a)*(a-r),l=d**2-c*((n-h)**2+(a-r)**2-o**2);if(l<0)return!1;let m;return m=(-d-Math.sqrt(l))/c,0<=m&&m<=1||(m=(-d+Math.sqrt(l))/c),0<=m&&m<=1&&{x:m*s+(1-m)*n,y:m*i+(1-m)*a}}{const[{x:s,y:i},{x:n,y:a}]=t,[{x:h,y:r},{x:o,y:c}]=e,d=((s-h)*(r-c)-(i-r)*(h-o))/((s-n)*(r-c)-(i-a)*(h-o));if(!(0<=d&&d<=1))return!1;const l=((s-h)*(i-a)-(i-r)*(s-n))/((s-n)*(r-c)-(i-a)*(h-o));return 0<=l&&l<=1&&{x:s+d*(n-s),y:i+d*(a-i)}}}function s(t,e){return Math.random()*(e-t)+t}class i{constructor(t,e){this.snek=t,this.snek.setMediator(this),this.pellet=e,this.pellet.setMediator(this)}notify(t){const[e,s]=t;switch(e){case"pointermove":this.snek.calculateSegments(),this.snek.calculateSpeed();break;case"eatpellet":this.snek.grow(),this.pellet.place(this.snek.segmentPath);break;default:return s}}}class n{constructor(t){this.mediator=t}setMediator(t){this.mediator=t}}class a extends n{constructor(t){super(),this.canvas=t,this.path=[],this.timeStamp=[],this.rawSpeed=0,this.moveHandler=this.moveHandler.bind(this)}moveHandler(t){const e={x:t.x-this.canvas.element.getBoundingClientRect().x,y:t.y-this.canvas.element.getBoundingClientRect().y};this.path.unshift(e),this.timeStamp.unshift(t.timeStamp),this.mediator.notify(["pointermove",this])}trim(t){this.path.splice(t),this.timeStamp.splice(t)}getSpeed(e=6){if((e=Math.min(e,this.path.length-1))<2)return 0;let s=0,i=0;for(let n=0;n<e;n++)s+=t(this.path[n],this.path[n+1]),i+=this.timeStamp[n]-this.timeStamp[n+1];return s/i}updateSpeed(){this.rawSpeed=this.getSpeed()}}class h extends a{constructor(t){super(t),this.segments=4,this.segLength=50,this.snekWidth=10,this.speed=0,this.segmentPath=[{x:this.canvas.width/2,y:this.canvas.height/2}];for(let t=0;t<this.segments;t++){const e={x:this.segmentPath[t].x,y:this.segmentPath[t].y+this.segLength};this.segmentPath.push(e)}}calculateSegments(){Object.assign(this.segmentPath,this.path,{length:1});let s=this.segmentPath[this.segmentPath.length-1];for(let[i,n]of this.path.entries())if(this.segmentPath.length<=this.segments)for(;this.segLength<t(s,n);){if(s=e([this.path[i-1],n],{center:s,radius:this.segLength}),this.segmentPath.push(s),this.segments<this.segmentPath.length)break}else 2*this.segLength<=t(s,n)&&super.trim(i)}calculateSpeed(){this.updateSpeed();this.rawSpeed,this.speed=.05*this.rawSpeed+.95*this.speed}grow(){this.segments+=1}}class r extends n{constructor(t){super(),this.radius=15,this.target=t,this.loc=Object.create({})}place(t,i=30){let n,a;for(;;){if(a=!0,n={x:s(i,this.target.clientWidth-i),y:s(i,this.target.clientHeight-i)},0===t.length){this.loc=n;break}for(let s=0;s<t.length-1;s++)if(e([t[s],t[s+1]],{center:n,radius:this.radius+i})){a=!1;break}if(a){Object.assign(this.loc,n);break}}}}function o(){let t,e;const s=parseInt(getComputedStyle(document.getElementById("game")).borderWidth),i=document.documentElement.clientHeight,n=document.documentElement.clientWidth,a=document.getElementById("ui")?.clientHeight;return(i-a)/n<1?(e=Math.min(600,i-a-2*s),t=1.5*e):(t=Math.min(600,n-2*s),e=1.5*t),[t,e]}class c{constructor(t,e,s){this.element=document.getElementById(t),this.context=this.element.getContext("2d"),void 0===e&&(e=this.element.clientWidth),void 0===s&&(s=this.element.clientHeight),this.width=e,this.height=s,this.setSize()}setSize(){this.element.style.width=`${this.width}px`,this.element.style.height=`${this.height}px`;const t=window.devicePixelRatio;this.element.width=Math.floor(this.width*t),this.element.height=Math.floor(this.height*t),this.context.scale(t,t)}clear(){this.context.clearRect(0,0,this.width,this.height)}}class d{setParent(t){this.parent=t}getParent(){return this.parent}}class l extends d{children=[];add(t){this.children.push(t),t.setParent(this)}remove(t){const e=this.children.indexOf(t);this.children.splice(e,1),t.setParent(null)}render(){for(const t of this.children)t.render()}}class m extends d{constructor(t,e){super(),this.data=t,this.target=e}}class g extends m{constructor(t,e,s,i){super(t,e),this.color=s,this.width=i}render(){const t=this.data;0!==t.length&&(this.target.strokeStyle=this.color,this.target.lineWidth=this.width,this.target.lineCap="round",this.target.lineJoin="round",this.target.beginPath(),this.target.moveTo(t[0].x,t[0].y),t.forEach((t=>{this.target.lineTo(t.x,t.y)})),this.target.stroke())}}class p extends m{constructor(t,e,s,i){super(t,e),this.color=s,this.width=i}render(){this.target.beginPath(),this.target.strokeStyle=this.color,this.target.lineWidth=this.width,this.target.arc(this.data.center.x,this.data.center.y,this.data.radius,0,2*Math.PI),this.target.stroke()}}class u extends m{constructor(t,e,s){super(t,e),this.color=s}render(){this.data.center&&(this.target.fillStyle=this.color,this.target.beginPath(),this.target.arc(this.data.center.x,this.data.center.y,this.data.radius,0,2*Math.PI),this.target.fill())}}class y extends m{constructor(t,e,s){super(t,e),this.color=s}render(){const t=this.data[0],e={x:this.data[1].x-t.x,y:this.data[1].y-t.y};this.target.fillStyle=this.color,this.target.fillRect(t.x,t.y,e.x,e.y)}}class x extends m{constructor(t,e){super(t,e),this.composite=new l}render(){const t=this.data.speedCanvas,e=new y([{x:0,y:0},{x:t.width,y:t.height}],t.context,"#eee"),s=new y([{x:0,y:0},{x:t.width*this.data.speedLimit/this.data.maxSpeed,y:t.height}],t.context,"orangered"),i=new w(this.data,t.context);return this.composite.add(e),this.composite.add(s),this.composite.add(i),this.composite.render()}}class w extends m{constructor(t,e){super(t,e)}render(){const t=this.data.speedCanvas,e=Math.min(this.data.snek.speed,this.data.maxSpeed),s=t.width*e/this.data.maxSpeed;this.target.fillStyle="green",this.target.beginPath(),this.target.moveTo(s-5,this.data.speedCanvas.height),this.target.lineTo(s+5,this.data.speedCanvas.height),this.target.lineTo(s+1,10),this.target.lineTo(s-1,10),this.target.fill()}}class S{constructor(){this.gameCanvas=new c("gameBoard",...o());document.getElementById("ui").style.width=`${this.gameCanvas.width}px`,this.speedCanvas=new c("speedometer"),this.snek=new h(this.gameCanvas),this.pellet=new r(this.gameCanvas.element),this.model=new i(this.snek,this.pellet),this.score=0;const t=localStorage.getItem("bestScore");this.bestScore=t?Number(t):0,this.speedLimit=0,this.maxSpeed=5,this.transitionTo(new f)}transitionTo(t){console.log(`Context: Transition to ${t.constructor.name}.`),this.state&&this.state.exit(),this.state=t,this.state.setContext(this),this.state.enter()}increaseScore(){this.score+=1,this.bestScore=Math.max(this.bestScore,this.score),this.speedLimit=Math.min(this.speedLimit+.05,this.maxSpeed)}restart(){this.snek=new h(this.gameCanvas),this.pellet=new r(this.gameCanvas.element),this.model=new i(this.snek,this.pellet),this.score=0;const t=localStorage.getItem("bestScore");this.bestScore=t?Number(t):0,this.speedLimit=0,this.maxSpeed=5}gameLoop(){this.update(),this.render(),this.reqId=requestAnimationFrame((()=>this.gameLoop()))}update(){document.getElementById("currentScore").innerHTML=`Score: ${String(this.score).padStart(2," ")}`;document.getElementById("bestScore").innerHTML=`Best: ${String(this.bestScore).padStart(2," ")}`,this.state.update()}render(){this.gameCanvas.clear(),this.speedCanvas.clear(),this.state.graphics.render()}}class v{constructor(t=new l){this.graphics=t,this.messageElement=document.getElementById("message")}setContext(t){this.game=t}update(){}}class f extends v{constructor(){super()}enter(){document.getElementById("info").style.display="flex";document.getElementById("startMessage").style.display="block";document.getElementById("endMessage").style.display="none";document.getElementById("startButton").addEventListener("click",(()=>this.game.transitionTo(new k)),{once:!0})}exit(){document.getElementById("info").style.display="none"}}class k extends v{constructor(){super(),this.checkPlayerReady=this.checkPlayerReady.bind(this)}enter(){this.messageElement.innerText="Pointer in the circle to start",this.initUiGraphics(),this.initGameGraphics(),document.addEventListener("pointermove",this.checkPlayerReady)}initUiGraphics(){const t=this.game.speedCanvas.context,e=new x(this.game,t);this.graphics.add(e)}initGameGraphics(){const t=this.game.gameCanvas,e=this.game.gameCanvas.context,s=this.game.snek,i=new l,n=new g(s.segmentPath,e,"green",s.snekWidth);i.add(n),this.graphics.add(i),this.readyArea={center:{x:t.width/2,y:t.height/2},radius:30},this.readyAreaGraphics=new p(this.readyArea,e,"blue",5),this.graphics.add(this.readyAreaGraphics)}checkPlayerReady(e){const s=this.game.gameCanvas.element.parentElement;t({x:e.x-s.offsetLeft-s.clientLeft,y:e.y-s.offsetTop-s.clientTop},this.readyArea.center)<this.readyArea.radius&&this.game.transitionTo(new E(this.graphics))}exit(){document.removeEventListener("pointermove",this.checkPlayerReady),this.graphics.remove(this.readyAreaGraphics)}}class E extends v{constructor(t){super(t),this.startTime=Date.now()}enter(){const t=this.game.snek;document.addEventListener("pointermove",t.moveHandler),document.addEventListener("touchend",this.touchCheck,{once:!0})}update(){const t=(Date.now()-this.startTime)/1e3;this.messageElement.innerText=String(3-Math.floor(t)),3<t&&this.game.transitionTo(new b(this.graphics))}touchCheck(){document.removeEventListener("pointermove",this.game.snek.moveHandler),this.game.transitionTo(new k)}exit(){document.removeEventListener("touchend",this.touchCheck)}}class b extends v{constructor(t){super(t)}enter(){this.messageElement.innerHTML="GO!",setTimeout((()=>{this.messageElement.innerText=""}),1e3);const t=this.game.pellet,e=this.game.snek;t.place(e.segmentPath);const s=this.game.gameCanvas.context;this.graphics.add(new u({center:this.game.pellet.loc,radius:this.game.pellet.radius},s,"blue"))}update(){const t=this.game.snek,s=t.segmentPath,i=t.segmentPath,n=this.game.pellet;t.speed<this.game.speedLimit&&(console.log("faster!"),this.game.transitionTo(new P("You were too slow!"))),n.loc&&2<=i.length&&e([i[0],i[1]],{center:n.loc,radius:n.radius+t.snekWidth/2})&&(console.log("nom!"),this.game.increaseScore(),this.game.model.notify(["eatpellet",this]));const a=this.game.gameCanvas.element;(s[0].x-1<=0||a.clientWidth-1<=s[0].x||s[0].y-1<=0||a.clientHeight-1<=s[0].y)&&(console.log("whoops!"),this.game.transitionTo(new P("You crashed into a wall!")));for(let t=2;t<s.length-1;t++)e([s[0],s[1]],[s[t],s[t+1]])&&(console.log("ouch!"),this.game.transitionTo(new P("You crashed into yourself!")))}exit(){document.removeEventListener("pointermove",this.game.snek.moveHandler)}}class P extends v{constructor(t){super(),this.reason=t}enter(){localStorage.setItem("bestScore",String(this.game.bestScore));document.getElementById("reason").innerText=this.reason;document.getElementById("score").innerText=`Score: ${this.game.score}`;document.getElementById("best").innerText=`Best: ${this.game.bestScore}`+(this.game.score===this.game.bestScore?" (NEW BEST!)":"");document.getElementById("info").style.display="flex";document.getElementById("startMessage").style.display="none";document.getElementById("endMessage").style.display="block";document.getElementById("restartButton").addEventListener("click",(()=>this.game.transitionTo(new f)),{once:!0})}exit(){this.game.restart()}}window.addEventListener("load",(()=>{(new S).gameLoop()}));
//# sourceMappingURL=index.3f025905.js.map
